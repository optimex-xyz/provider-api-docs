# Trading API V2

This document describes the Trading API V2 endpoints for executing cross-chain token swaps.

## Table of Contents

- [Create Trade Quote](#1-create-trade-quote)
- [Submit Transaction](#2-submit-transaction)
- [Get Trade Details](#3-get-trade-details)
- [List Trades](#4-list-trades)

---

## 1. Create Trade Quote

Creates a new trade quote and returns deposit information for executing the swap.

### Endpoint

```http
POST /v2/trades/quote
```

### Request Body

| Field                | Type     | Required | Description                                                                 |
| -------------------- | -------- | -------- | --------------------------------------------------------------------------- |
| `from_token_id`      | `string` | Yes      | Source token identifier (e.g., `"BTC"`, `"ETH"`)                            |
| `to_token_id`        | `string` | Yes      | Destination token identifier (e.g., `"ETH"`, `"BTC"`)                       |
| `amount_in`          | `string` | Yes      | Amount to send in the smallest unit (bigint as string)                      |
| `slippage`           | `string` | No       | Slippage tolerance in basis points. Default: `"100"` (1%)                   |
| `affiliate_fee_bps`  | `string` | No       | Affiliate fee in basis points                                               |
| `from_user_address`  | `string` | Yes      | User's source address for the input token (crosschain format)               |
| `to_user_address`    | `string` | Yes      | User's destination address for receiving the output token (crosschain format) |
| `user_refund_pubkey` | `string` | Yes      | User's public key for refunds (crosschain format)                           |
| `trade_timeout`      | `number` | No       | Trade timeout in seconds. Default: `7200` (2 hours)                         |
| `script_timeout`     | `number` | No       | Script timeout in seconds. Default: `86400` (24 hours)                      |
| `affiliate_info`     | `array`  | No       | Array of affiliate configuration objects (see below)                        |

#### Affiliate Info Object

| Field      | Type     | Required | Description                                              |
| ---------- | -------- | -------- | -------------------------------------------------------- |
| `provider` | `string` | Yes      | Name of the affiliate provider                           |
| `rate`     | `string` | Yes      | Fee rate in basis points (e.g., `"25"` for 0.25%)        |
| `receiver` | `string` | Yes      | Address to receive affiliate fees                        |
| `network`  | `string` | No       | Network where affiliate fees will be paid                |

### Request Example

```json
{
  "from_token_id": "BTC",
  "to_token_id": "ETH",
  "amount_in": "100000000",
  "slippage": "100",
  "from_user_address": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
  "to_user_address": "0x742d35Cc6634C0532925a3b844Bc9e7595f8b2c0",
  "user_refund_pubkey": "02a1633cafcc01ebfb6d78e39f687a1f0995c62fc95f51ead10a02ee0be551b5dc",
  "affiliate_info": [
    {
      "provider": "partner_app",
      "rate": "25",
      "receiver": "0x1234567890abcdef1234567890abcdef12345678",
      "network": "ethereum"
    }
  ]
}
```

### Response

**Status:** `200 OK`

| Field             | Type     | Description                                          |
| ----------------- | -------- | ---------------------------------------------------- |
| `trade_id`        | `string` | Unique trade identifier                              |
| `deposit_address` | `string` | Address where the user should send the input tokens  |
| `payload`         | `string` | Transaction payload (only present for EVM trades)    |
| `min_amount_out`  | `string` | Minimum expected output amount after slippage        |

### Response Example

```json
{
  "data": {
    "trade_id": "0x1234567890abcdef1234567890abcdef",
    "deposit_address": "bc1q...",
    "min_amount_out": "32500000000000000000"
  }
}
```

---

## 2. Submit Transaction

Notifies the system that the user has submitted the deposit transaction on the source chain.

### Endpoint

```http
POST /v2/trades/submit-tx
```

### Request Body

| Field      | Type     | Required | Description                              |
| ---------- | -------- | -------- | ---------------------------------------- |
| `trade_id` | `string` | Yes      | Unique trade identifier from quote       |
| `tx_id`    | `string` | Yes      | Transaction hash/ID on the source chain  |

### Request Example

```json
{
  "trade_id": "0x1234567890abcdef1234567890abcdef",
  "tx_id": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
}
```

### Response

**Status:** `200 OK`

| Field | Type     | Description          |
| ----- | -------- | -------------------- |
| `msg` | `string` | Confirmation message |

### Response Example

```json
{
  "data": {
    "msg": "Transaction submitted successfully"
  }
}
```

---

## 3. Get Trade Details

Retrieves detailed information about a specific trade, including its current status, token information, and event history.

### Endpoint

```http
GET /v2/trades/{trade_id}
```

### Path Parameters

| Parameter  | Type     | Description             |
| ---------- | -------- | ----------------------- |
| `trade_id` | `string` | Unique trade identifier |

### Response

**Status:** `200 OK`

| Field               | Type     | Description                                               |
| ------------------- | -------- | --------------------------------------------------------- |
| `trade_id`          | `string` | Unique trade identifier (32-byte hex with `0x` prefix)    |
| `state`             | `string` | Current trade state (e.g., `success`, `pending`, `failed`)|
| `swap_type`         | `string` | Type of swap (`bridge` or `direct`)                       |
| `trade_timeout`     | `number` | Trade timeout as Unix timestamp                           |
| `script_timeout`    | `number` | Script timeout as Unix timestamp                          |
| `from_user_address` | `string` | User's source address                                     |
| `to_user_address`   | `string` | User's destination address                                |
| `deposit_tx`        | `string` | Deposit transaction hash                                  |
| `settlement_tx`     | `string` | Settlement transaction hash                               |
| `amount_in`         | `string` | Input amount in smallest unit                             |
| `min_amount_out`    | `string` | Minimum expected output amount                            |
| `from_token`        | `object` | Source token details (see Token Object)                   |
| `to_token`          | `object` | Destination token details (see Token Object)              |
| `events`            | `array`  | Array of trade events (see Event Object)                  |

#### Token Object

| Field                  | Type     | Description                                      |
| ---------------------- | -------- | ------------------------------------------------ |
| `id`                   | `number` | Internal token ID                                |
| `chain_id`             | `string` | Chain ID (empty for non-EVM chains)              |
| `token_id`             | `string` | Unique token identifier                          |
| `swap_type`            | `string` | Swap type (`bridge` or `direct`)                 |
| `network_id`           | `string` | Network identifier                               |
| `token_name`           | `string` | Full token name                                  |
| `network_name`         | `string` | Full network name                                |
| `network_type`         | `string` | Network type (`EVM`, `BTC`, etc.)                |
| `token_symbol`         | `string` | Token symbol                                     |
| `token_address`        | `string` | Token contract address (`native` for native tokens) |
| `token_logo_uri`       | `string` | URL to token logo                                |
| `network_symbol`       | `string` | Network symbol                                   |
| `token_decimals`       | `number` | Token decimal places                             |
| `network_logo_uri`     | `string` | URL to network logo                              |
| `canonical_token_id`   | `string` | Canonical token identifier (for bridged tokens)  |
| `across_token_address` | `string` | Across protocol token address                    |

#### Event Object

| Field          | Type     | Description                                         |
| -------------- | -------- | --------------------------------------------------- |
| `action`       | `string` | Event action type (see Event Actions below)         |
| `tx_id`        | `string` | Transaction hash associated with the event (nullable) |
| `block_number` | `number` | Block number where the event occurred               |
| `timestamp`    | `number` | Event timestamp as Unix timestamp                   |
| `input_data`   | `object` | Event-specific data                                 |

#### Event Actions

| Action              | Description                                      |
| ------------------- | ------------------------------------------------ |
| `INIT`              | Trade initialized                                |
| `Deposited`         | User deposit detected                            |
| `SubmittedToSolver` | Trade submitted to solver for processing         |
| `SubmitTradeInfo`   | Trade information submitted to contract          |
| `ConfirmDeposit`    | Deposit confirmed by MPC                         |
| `SelectPMM`         | PMM (Private Market Maker) selected              |
| `MakePayment`       | Payment initiated                                |
| `ConfirmPayment`    | Payment confirmed by MPC                         |
| `ConfirmSettlement` | Settlement confirmed, trade completed            |

### Response Example

```json
{
  "data": {
    "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502",
    "state": "success",
    "trade_timeout": 1765367266,
    "script_timeout": 1765439266,
    "from_user_address": "0x19ce4de99ce88bc4a759e8dbdec42724eecb666f",
    "to_user_address": "tb1p0k7s75ddzr8wrst9raalymqkrzpz6ppcwtph0mqwx0j7kmg39sjq5553aj",
    "deposit_tx": "0xe209ae0df25c2fa871d5e4a66d4d4bbb11f6f7429868585a0b1bf8be5dd8b64c",
    "settlement_tx": "dbfc71eab03ed3ae3bc0bef246d78ba7bbf92789aee6191a034792dbc9465b79",
    "swap_type": "bridge",
    "amount_in": "12000000000000000000",
    "min_amount_out": "11947",
    "from_token": {
      "id": 18,
      "chain_id": "97",
      "token_id": "bsc_testnet_USDC",
      "swap_type": "bridge",
      "network_id": "bsc_testnet",
      "token_name": "USD Coin",
      "network_name": "BSC Testnet",
      "network_type": "EVM",
      "token_symbol": "USDC",
      "token_address": "0xc77A4A85398889853311e8Ab386Fee439B2400da",
      "token_logo_uri": "https://static.optimex.xyz/crypto_svg_logos/usdc.svg",
      "network_symbol": "ETH",
      "token_decimals": 18,
      "network_logo_uri": "https://static.optimex.xyz/crypto_svg_logos/bsc.svg",
      "canonical_token_id": "ethereum_sepolia_USDC",
      "across_token_address": "0xc77A4A85398889853311e8Ab386Fee439B2400da"
    },
    "to_token": {
      "id": 2,
      "chain_id": "",
      "token_id": "tBTC",
      "swap_type": "direct",
      "network_id": "bitcoin_testnet",
      "token_name": "Bitcoin Testnet",
      "network_name": "Bitcoin Testnet",
      "network_type": "BTC",
      "token_symbol": "BTC",
      "token_address": "native",
      "token_logo_uri": "https://static.optimex.xyz/crypto_svg_logos/tBTC.svg",
      "network_symbol": "BTC",
      "token_decimals": 8,
      "network_logo_uri": "https://static.optimex.xyz/crypto_svg_logos/btc_network.svg",
      "canonical_token_id": "",
      "across_token_address": ""
    },
    "events": [
      {
        "action": "ConfirmSettlement",
        "tx_id": "0x6efbc5487e03ffb54204acddb09c94dc3c5bdc034f8b0edcff714e21105c6997",
        "block_number": 14084322,
        "timestamp": 1765353180,
        "input_data": {
          "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502",
          "release_tx_id": "0x60c64858a651cf91abb5510a73d8a2fb4407d8dd4960af772147f356f86b38b4"
        }
      },
      {
        "action": "ConfirmPayment",
        "tx_id": "0x938d03a8c39c75707f52bd0325caf07bfa49e5ed1c39feb4f7c556866ff6a3c9",
        "block_number": 14084230,
        "timestamp": 1765352996,
        "input_data": {
          "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502"
        }
      },
      {
        "action": "MakePayment",
        "tx_id": "0xfb3ac809a36af76b64459a60f1eba29c083827c836e71e13915faa4c3c72622f",
        "block_number": 14084223,
        "timestamp": 1765352982,
        "input_data": {
          "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502",
          "payment_tx_id": "dbfc71eab03ed3ae3bc0bef246d78ba7bbf92789aee6191a034792dbc9465b79",
          "actual_amount_out": "12108"
        }
      },
      {
        "action": "SelectPMM",
        "tx_id": "0x8c72dc10e2943410c52264c5ac003dcbc3f7df288458c462cd2e4caaea8c26ac",
        "block_number": 14084219,
        "timestamp": 1765352974,
        "input_data": {
          "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502",
          "solver": "0xc3DF02f16f5629729a319b68DA3Bed6c94355e41"
        }
      },
      {
        "action": "ConfirmDeposit",
        "tx_id": "0xc812d3e51c1c4036d5bd36b2de7b022d29bc3495aa2253250d129e8f41db7478",
        "block_number": 14084205,
        "timestamp": 1765352946,
        "input_data": {
          "trade_id": "0x3229ba35d4d55dcf3395579308af8131d548c8b779b669b738b827225c9df502"
        }
      },
      {
        "action": "Deposited",
        "tx_id": "0xe209ae0df25c2fa871d5e4a66d4d4bbb11f6f7429868585a0b1bf8be5dd8b64c",
        "block_number": 0,
        "timestamp": 1765352896,
        "input_data": {
          "deposit_tx_id": "0xe209ae0df25c2fa871d5e4a66d4d4bbb11f6f7429868585a0b1bf8be5dd8b64c",
          "vault_address": "0x49afc6368C087dBDa6DC623E991D3b98c1Bd752e"
        }
      },
      {
        "action": "INIT",
        "tx_id": null,
        "block_number": 0,
        "timestamp": 1765352870,
        "input_data": {
          "amount_in": "12000000000000000000",
          "min_amount_out": "11947"
        }
      }
    ]
  }
}
```

---

## 4. List Trades

Retrieves a paginated list of trades with optional filtering.

### Endpoint

```http
GET /v2/trades
```

### Query Parameters

| Parameter | Type     | Required | Description                               |
| --------- | -------- | -------- | ----------------------------------------- |
| `limit`   | `number` | No       | Number of trades to return. Default: `20` |
| `offset`  | `number` | No       | Number of trades to skip. Default: `0`    |
| `status`  | `string` | No       | Filter trades by status                   |

### Response

**Status:** `200 OK`

| Field    | Type     | Description                        |
| -------- | -------- | ---------------------------------- |
| `trades` | `array`  | Array of trade summary objects     |
| `total`  | `number` | Total number of matching trades    |
| `limit`  | `number` | Number of trades per page          |
| `offset` | `number` | Current offset                     |

#### Trade Summary Object

| Field           | Type     | Description                         |
| --------------- | -------- | ----------------------------------- |
| `trade_id`      | `string` | Unique trade identifier             |
| `from_token_id` | `string` | Source token identifier             |
| `to_token_id`   | `string` | Destination token identifier        |
| `amount_in`     | `string` | Input amount in smallest unit       |
| `amount_out`    | `string` | Output amount in smallest unit      |
| `status`        | `string` | Current trade status                |
| `created_at`    | `string` | Trade creation timestamp (ISO 8601) |
| `updated_at`    | `string` | Last update timestamp (ISO 8601)    |

### Response Example

```json
{
  "data": {
    "trades": [
      {
        "trade_id": "0x1234567890abcdef1234567890abcdef",
        "from_token_id": "BTC",
        "to_token_id": "ETH",
        "amount_in": "100000000",
        "amount_out": "32500000000000000000",
        "status": "completed",
        "created_at": "2024-01-15T10:30:00Z",
        "updated_at": "2024-01-15T10:45:00Z"
      }
    ],
    "total": 150,
    "limit": 20,
    "offset": 0
  }
}
```
